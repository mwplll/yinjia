/**
 * Created by zyc on 2014/12/27.
 */
//var ITEMS = [
//    "水电基础装饰部分,泥水基础装饰部分,木作基础装饰部分,油漆基础装饰部分, 其它杂项(搬运、清理、打扫)",
//
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品装饰柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品装饰柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品衣柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品衣柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品衣柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品书柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带",
//
//    "抛光砖,大理石,防古砖,大理石门槛板,踢脚线(砖类),踢脚线(石材类),钛合金移门,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,集成扣板,橱柜上柜,橱柜下柜,台面板,乳胶漆,墙纸,换气扇,厨房水槽,三角阀,不锈钢波纹管,厨房水龙头,油烟机,消毒柜,煤气灶,射灯(小),射灯(中),筒灯,LED灯带,铝板吊灯配套内嵌灯盘",
//    "抛光砖,大理石,防古砖,大理石门槛板,踢脚线(砖类),踢脚线(石材类),钛合金移门,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,集成扣板,洗脸盆柜,装饰镜,洗脸盆台面板,乳胶漆,墙纸,换气扇,淋浴龙头,浴缸龙头,洗脸盆龙头,地漏,座便器,浴缸,拖把池,洗脸盆,三角阀,不锈钢波纹管,浴霸(风暖),浴霸(灯暖),射灯(小),射灯(中),筒灯,LED灯带,铝板吊灯配套内嵌灯盘,淋浴房,卫浴五金件",
//    "抛光砖,大理石,防古砖,大理石门槛板,踢脚线(砖类),踢脚线(石材类),钛合金移门,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,集成扣板,洗脸盆柜,装饰镜,洗脸盆台面板,乳胶漆,墙纸,换气扇,淋浴龙头,浴缸龙头,洗脸盆龙头,地漏,座便器,浴缸,拖把池,洗脸盆,三角阀,不锈钢波纹管,浴霸(风暖),浴霸(灯暖),射灯(小),射灯(中),筒灯,LED灯带,铝板吊灯配套内嵌灯盘,淋浴房,卫浴五金件",
//
//    "抛光砖,大理石,防古砖,户外地板,大理石门槛板,踢脚线(砖类),踢脚线(石材类),成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,集成扣板,洗衣台,乳胶漆,洗衣台龙头,地漏,拖把池,三角阀,不锈钢波纹管,射灯(小),射灯(中),筒灯,LED灯带",
//    "抛光砖,大理石,防古砖,户外地板,大理石门槛板,踢脚线(砖类),踢脚线(石材类),成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,乳胶漆,地漏,射灯(小),射灯(中),筒灯,LED灯带",
//
//    "抛光砖,大理石,防古砖,大理石门槛板,大理石窗台板,踢脚线(砖类),踢脚线(石材类),实木地板,强化地板,实木复合地板,配套木踢脚线,不锈钢踢脚线,成品门、门套(平板),成品门、门套(造型),执手锁,成品垭口门套,成品窗套线,石膏线条,木饰面造型,木线条,成品软包,成品硬包,成品书柜,乳胶漆,墙纸,射灯(小),射灯(中),筒灯,LED灯带"
//];
//
var ROOMS = [
    {name: '客厅部分', type: 1},
    {name: '餐厅部分', type: 2},
    {name: '客餐厅部分', type: 3},
    {name: '主卧室部分', type: 4},
    {name: '次卧室一', type: 5},
    {name: '次卧室二', type: 6},
    {name: '次卧三(书房)', type: 7},
    {name: '厨房部分', type: 8},
    {name: '卫生间部分(主卫)', type: 9},
    {name: '卫生间部分(次卫)', type: 10},
    {name: '洗衣阳台部分', type: 11},
    {name: '生活阳台部分', type: 12},
    {name: '家电成品', type: 13}
];
var ITEMS = [
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, (石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),鞋柜(*),家庭储藏柜(*),储藏间,装饰镜",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),鞋柜(*),家庭储藏柜(*),储藏间,装饰镜",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),鞋柜(*),家庭储藏柜(*),储藏间,装饰镜",

    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),衣柜(*),走入式衣柜(*),装饰镜",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),衣柜(*),走入式衣柜(*)",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),衣柜(*),走入式衣柜(*)",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),衣柜(*),走入式衣柜(*)",

    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),厨房橱柜(上柜),厨房橱柜(下柜),厨房台面(石英石、人造石),厨房水槽,厨盆龙头,地漏",

    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),整体浴室柜(上下柜带镜子),储物柜,衣柜(*),坐便器,台盆,台盆龙头,花洒,玻璃淋浴房,浴缸,浴缸龙头,卫浴四件套,地漏,防雾镜(包安装)",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),整体浴室柜(上柜), 整体浴室柜(下柜),衣柜(*),坐便器,台盆,台盆龙头,花洒,玻璃淋浴房,浴缸,浴缸龙头,卫浴四件套,地漏,防雾镜(包安装)",

    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),储藏柜(*), 整体浴室柜(上柜), 整体浴室柜(下柜),拖把池,拖把池龙头,洗衣龙头,地漏",
    "地砖楼地面,地砖楼地面,地砖楼地面,地砖楼地面, (地砖走边)楼地面, 石材开槽淋浴房底座,(石材)楼地面湿铺,(石材)楼地面嵌边,零星装饰项目(石材),强化地板(含地板防潮膜/含配套踢脚),实木复合地板(含地板防潮膜/含配套踢脚),实木地板(木龙骨、实木地板、地板防潮膜),成品木饰面踢脚线,墙面,墙面,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),木线条,护墙板,成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内),(木材)窗台板(20CM宽以内),储藏柜(*),地漏",

//    "墙面300*600,墙面400*800,墙面马赛克,(石材)墙面,墙纸(布)一:(满刮腻子、墙纸专用基膜、墙纸裱糊),墙纸(布)二:(满刮腻子、墙纸专用基膜、墙纸裱糊),防雾镜安装",
//    "成品装饰木门一(含安装),成品装饰木门二(含安装),执手门锁安装(单开),执手门锁安装(双开),木饰面门套,木饰面窗套,门套线木脚基座,(石材)门窗套(六面防护、石材磨边),(石材)石材基脚,(石材)窗台板(20CM宽以内)",
//    "厨房橱柜(上柜),厨房橱柜(下柜),厨房台面(石英石、人造石),鞋柜(*),整体浴室柜,衣柜(*),走入式衣柜(*)",
//    "厨房水槽,厨盆龙头,坐便器,台盆,台盆龙头,花洒,玻璃淋浴房,浴缸,浴缸龙头,厕纸架,马桶刷,毛巾架,浴巾架,地漏",

    "开关插座面板,筒灯,LED灯带(含灯带插头),吸顶灯,射灯,换气扇,地热,煤气灶,油烟机,空调"
];

var BASE_MODEL = [];
for(var i = 0; i < ROOMS.length; i++){
    var t = ITEMS[i].split(",");
    BASE_MODEL.push(createItem(ROOMS[i], t, i+1));
}

_dialogs_ = {};

var selectGoodsCtr = avalon.define({
    $id: 'SelectGoodsController',

    okHandler: function(){
        if(!goodsDetailCtr.selectProd ){
            Tip.alert("请先选择规格");
            return;
        }
        var pd = {
            goodsId: goodsDetailCtr.detailObj.id,
            unit: goodsDetailCtr.detailObj.unit,
            material: goodsDetailCtr.detailObj.name,
            keywords: KeyMap[goodsDetailCtr.detailObj.name],
            num: Number(goodsDetailCtr.copy),
            price: goodsDetailCtr.selectProd.sellPrice,
            productsId: goodsDetailCtr.selectProd.productsId,
            specArray: ''
        };
        pd['total'] = Number((pd['num'] * pd['price']).toFixed(2));
        _dialogs_['select_goods'].close();

        var specArray = [];
        if(goodsDetailCtr.selectValue && goodsDetailCtr.selectValue.length){
            avalon.each(goodsDetailCtr.selectValue, function(i, it){
                if(it.type == 1){
                    specArray.push(it.picName);
                }else{
                    specArray.push(it.value);
                }
            });
        }
        if(specArray.length){
            pd['specArray'] = "(" + specArray.toString() + ")";
        }

        // 更新选择的建材
        _.extend(selectGoodsItem, pd);

        // 计算当前房间总价
        publishMaterialCtr.getGoodsByRoom(selectRoomItem);
        // 计算当前房间单方造价
        publishMaterialCtr.blurHandler(selectRoomItem);
        // 统计
        publishMaterialCtr.calTotal();
    },
    rows: [],
    selectId: '',

    init: function(item){
        if(selectGoodsItem && selectGoodsItem.goodsId && selectGoodsItem.goodsId == item.goodsId){
            return;
        }

        selectGoodsItem = item;

        selectGoodsCtr.rows = [];
        selectGoodsCtr.selectId = '';

        goodsDetailCtr.clearHandler();

        require("UtilController", function(AjaxUtil){
            AjaxUtil.getAction({
                url: Global_URL['listGoods'],
                data: {num: 1000, page: 1, keywords: KeyMap[item.name]},
                callback: function(result){
                    if(!result.data.goodsList
                        || !result.data.goodsList.length){
                        return;
                    }
                    var list = result.data.goodsList;
                    avalon.each(list, function(i, it){

                    });
                    selectGoodsCtr.rows = list;

                    // 单个详情
//                    goodsDetailCtr.getDetailHandler(list[0].id);
                    selectGoodsCtr.selectId = list[0].id;
                }
            });
        });
    }
});

selectGoodsCtr.$watch("selectId", function(){
    if(!selectGoodsCtr.selectId){
        return;
    }
    goodsDetailCtr.getDetailHandler(selectGoodsCtr.selectId);
});

var selectGoodsItem;
var selectRoomItem;
var selectRoomCtr = avalon.define({
    $id: 'SelectRoomController',
    rooms: avalon.mix(true, [], ROOMS.slice(0,100)),
    selectIndex: -1,

    selectHandler: function(el, index){
        selectRoomCtr.selectIndex = index;
        selectRoomCtr.selectValue = el.name;

        var t = ITEMS[index].split(",");
        var len = publishMaterialCtr.rows.length + 1;
        publishMaterialCtr.rows.push(createItem(ROOMS[index], t, len))
    },
    selectValue: ''
});
var selectStyleCtr = avalon.define({
    $id: 'SelectStyleController',
    list: [1],
    selectIndex: -1,

    houseArea: 0,

    manuList: [],
    selectHandler: function(el, index){
        if(selectStyleCtr.selectIndex == index){
            return;
        }
        selectStyleCtr.selectIndex = index;
        selectStyleCtr.selectValue = el.name;

        selectStyleCtr.manuList.clear();
        selectStyleCtr.manuList = avalon.mix(true, [], el.items.$model);

        publishMaterialCtr.calTotal();
    },
    selectValue: ''
});

var publishMaterialCtr = avalon.define({
    $id: 'PublishMaterialController',
    rows: [],
    first: [],

    totalSize: '',   // 合计 总面积
    totalPrice: '',  // 合计 总价
    curStep: 4,

    activeHandler: function(el){
        el.active = !el.active;
    },
    preHandler: function(){
        var url = 'publish-cad.html?house_id='+  houseCtr.houseId ;
        if(design_id){
            url += '&design_id=' + design_id;
        }
        location.href = url;
    },
    selectHandler: function(item, room){
        require([
            'ArtDialogPlugin',
            "text!../../schema/views/select-goods-dialog.html"
        ], function(_,html){
            var d = dialog({
                fixed: true,
                width: 812,
                content: html
            });
            avalon.scan();
            d.showModal();
            _dialogs_['select_goods'] = d;

            selectGoodsCtr.init(item);
//            selectGoodsItem = item;
            selectRoomItem = room;
        });
    },
    blurHandler: function(el){
        var size = Number(el.size) || 0;
        size = Math.max(0, size);
        el.size = size = Number(size.toFixed(2));
        if(size > 0){
            el.unitPrice = (Number(el.totalPrice) / size).toFixed(2);
        }
        publishMaterialCtr.calTotal();
    },
    calTotal: function(){
        var t = 0, t2 = 0;
        avalon.each(publishMaterialCtr.rows, function(i, r){
            t += Number(r.size);
            t2 += Number(r.totalPrice);
        });
        if(selectStyleCtr.selectIndex >= 0){
            t2 += Number(selectStyleCtr.list[selectStyleCtr.selectIndex].totalPrice * selectStyleCtr.houseArea);
        }
        publishMaterialCtr.totalPrice = t2.toFixed(2);
        publishMaterialCtr.totalSize = t.toFixed(2);
    },
    removeHandler: function(el, index){
        require(['ArtDialogPlugin'], function () {
            var d = dialog({
                content: "确认删除？",
                cancel: function(){},
                cancelValue: '取消',
                ok: function(){
                    publishMaterialCtr.rows.splice(index, 1);

                },
                okValue: '确定',
                quickClose: false
            });
            d.showModal();
        });
        return;
    },

    getFormValues: function(){
        var list = [],
            rows = publishMaterialCtr.rows.$model;
        avalon.each(rows, function(i, item){
            var tp = publishMaterialCtr.getGoodsByRoom(item);
            list.push({
                roomId: item.id || null,
                roomName: item.name,
                roomArea: item.size,
                roomType: item.type,
                materialList: tp
            });
        });
        return list;
    },
    getGoodsByRoom: function(room){
        var result = [],
            goods = room.items;
        var totalPrice = 0;
        avalon.each(goods, function(i, good){
            if(good.goodsId){
                result.push({
                    "materialId": good.materialId,  //材料id，新增时不传，编辑时传入
                    "materialNo": good.index,        //材料编号
                    "materialName": good.name,  //材料类目名称，前端写死的那个
                    "goodsId": good.goodsId,         //商品id
                    "productsId": good.productsId,  //货品id
                    "num": good.num,                  //货品数量
                    "content": good.memo             //设计师备注
                });
                totalPrice += Number(good.total)
            }
        });
        room.totalPrice = Number(totalPrice.toFixed(2));
        return result;
    },

    saveHandler: function () {
        var pd = {
            id: design_id,
            roomList: publishMaterialCtr.getFormValues()
        };
        var styleId;
        if(selectStyleCtr.selectIndex >= 0){
            styleId = selectStyleCtr.list[selectStyleCtr.selectIndex].id;
        }
        if(!styleId){
            Tip.alert("请选择施工风格");
            return;
        }
        if(!pd.roomList.length){
            Tip.alert("请先添加主材包");
//            location.href = '../schema/publish-audit.html'
//                +'?design_id=' + design_id
//                +'&house_id=' + houseCtr.houseId;
            return;
        }
        var re = publishMaterialCtr.validateHandler(pd);
        if(!re.success){
            Tip.alert(re.message);
            return;
        }
        require(['UtilController'], function (AjaxFunc) {
            AjaxFunc.saveAction({
                url: Global_URL['saveDesignStyle'],
                data: {id: design_id, styleId: styleId},
                callback: function (result) {
                    AjaxFunc.saveAction({
                        url: Global_URL['publishDesignMaterial'],
                        data: pd,
                        crossDomain: Global_CrossDomain,
                        method: 'POST',
                        callback: function (result) {
                            location.href = '../schema/publish-audit.html'
                                +'?design_id=' + design_id
                                +'&house_id=' + houseCtr.houseId;
                        }
                    });
                }
            });

        })
    },

    validateHandler: function(pd){
        var fg = true, msg = '';
        for(var i = 0, len = pd.roomList.length; i < len; i++){
            var room = pd.roomList[i];
            room.roomArea = Number(room.roomArea) || 0;
            room.roomArea = Number(room.roomArea.toFixed(2));
            if(room.roomName != '家电成品'){
                if(!room.roomArea || room.roomArea <=0 ){
                    msg = '请填写房间面积';
                    fg = false;
                    break;
                }
                if(!room.materialList.length){
                    msg = '请为房间选择建材';
                    fg = false;
                    break;
                }
            }
        }
        return{
            success: fg,
            message: msg
        };
    }
});

var design_id = null;
var city_id = null;
require(['UtilController'], function(AjaxFunc){
    design_id = AjaxFunc.getQueryStringByName('design_id');
    city_id = AjaxFunc.getQueryStringByName('city_id');
    var house_id = AjaxFunc.getQueryStringByName('house_id');
    if(!design_id){
        return;
    }
    AjaxFunc.getAction({
        url: Global_URL['getDesignMaterial'],
        data: {id: design_id},
        callback: function(result){
            publishMaterialCtr.rows = initRooms(result.data);
            avalon.log(result.data);
            publishMaterialCtr.calTotal();
        }
    });
    var houseCtr = avalon.vmodels['HouseController'];
    if(!houseCtr['grossArea']){
        AjaxFunc.getAction({
            url: Global_URL['getHouseInfoById'],
            data: {id: house_id},
            callback: function(result){
                houseCtr['grossArea'] = result.data['grossArea'];
                houseCtr['usableArea'] = result.data['usableArea'];
                selectStyleCtr['houseArea'] = Number(result.data['grossArea']);

            }
        });
    }else{
        selectStyleCtr['houseArea'] = Number(houseCtr['grossArea']);
    }

    // 施工风格
    AjaxFunc.getAction({
        url: Global_URL['getDesignManuList'],
        data: {id: design_id},
        callback: function(result){
            var t = 0, re = {};
            re = _.groupBy(result.data, function(item){
                return item.styleId;
            });
            var tp = [];
            for(var key in re){
                var total = 0;
                avalon.each(re[key], function(i, it){
                    total += Number(it.price);
                });
                total = Number(total.toFixed(2));
                var obj = {
                    name: re[key][0].styleName,
                    items: re[key],
                    totalPrice: total,
                    id: key
                };
                tp.push(obj);
            }
            selectStyleCtr.list.clear();
            selectStyleCtr.list = tp;

            getDesignManuInfo(AjaxFunc);
        }
    });
});


function getDesignManuInfo(AjaxFunc){
    AjaxFunc.getAction({
        url: Global_URL['getDesignManuInfo'],
        data: {id: design_id},
        alert: true,
        callback: function(result){
            if(result.errorCode != 22000){
                selectStyleCtr.selectHandler(selectStyleCtr.list[0], 0);
                return;
            }

            var styleId = Number(result.data[0].styleId);
            avalon.each(selectStyleCtr.list, function(i, it){
                if(Number(it.id) == styleId){
                    selectStyleCtr.selectHandler(it, i);
                }
            });
        }
    });
}

function createItem(room, its, index){
    var temp = createGoodsList(its, index);
    return {
        id: null,
        name: room.name,
        type: room.type,
        size: '',
        totalPrice: '',
        unitPrice: '',
        active: false,
        items: temp
    }
}
function createGoodsList(items, index){
    var temp = [];
    for(var i = 0; i < items.length;i++){
        temp.push({
            name: items[i],
            needMaterial: true,
            index: index + '-' + (i+1),
            num: '',
            unit: '',
            material: '',
            materialId: null,
            productsId: '',
            specArray: '',
            goodsId: '',
            price: '',
            total: '',
            memo: ''
        });
    }
    return temp;
}

function initRooms(rooms){
    var tp = [];
    avalon.each(rooms, function(i, room){
        room.roomType = Number(room.roomType);
        var pd = initGoodsByRoom(room, i + 1);
        tp.push(pd);
    });
    return tp;
}

function getGoodsByType(type,index){
    var idx = -1;
    avalon.each(ROOMS, function(i, room){
        if(room.type == type){
            idx = i;
        }
    });
    var t = ITEMS[idx].split(",");
    return createGoodsList(t, index);
}
function initGoodsByRoom(room, index){
    var goods = getGoodsByType(room.roomType, index);
    var totalPrice = 0;
    var pd = {
        id: room.roomId,
        name: room.roomName,
        type: room.roomType,
        size: room.roomArea,
        active: false,
        unitPrice: '',
        totalPrice: ''
    };
    avalon.each(goods, function(i, good){
        avalon.each(room.materialList, function(j, material){
            if(good.name == material.materialName){
                good.materialId = material.materialId;
                good.productsId = material.productsId;
                good.goodsId = material.goodsId;
                good.material = material.goodsName;
                good.unit = material.unit;
                good.price = Number(material.sellPrice);
                good.num = Number(material.num);
                good.memo = material.content;
                good.total = Number((good.price * good.num).toFixed(2));

                totalPrice += good.total;
            }
        });
    });
    pd.totalPrice = Number(totalPrice.toFixed(2));
    if(pd.size > 0){
        pd.unitPrice = Number((pd.totalPrice / pd.size).toFixed(2));
    }else{
        pd.unitPrice = 0;
    }

    pd.items = goods;
    return pd;
}

function customDropDown(ele){
    this.dropdown=ele;
    this.placeholder=this.dropdown.find(".placeholder");
    this.options=this.dropdown.find("ul.dropdown-menu > li");
    this.val='';
    this.index=-1;//默认为-1;
    this.initEvents();
}
customDropDown.prototype={
    initEvents:function(){
        var obj=this;
        //这个方法可以不写，因为点击事件被Bootstrap本身就捕获了，显示下面下拉列表
        obj.dropdown.on("click",function(event){
            $(this).toggleClass("active");
        });

        //点击下拉列表的选项
        obj.options.on("click",function(){
            var opt=$(this);
            obj.text=opt.find("a").text();
            obj.val=opt.attr("value");
            obj.index=opt.index();
            obj.placeholder.text(obj.text);
        });
    },
    getText:function(){
        return this.text;
    },
    getValue:function(){
        return this.val;
    },
    getIndex:function(){
        return this.index;
    }
};

require(['jquery',"Bootstrap"], function(){
    new customDropDown($("#dropdown"));
});
